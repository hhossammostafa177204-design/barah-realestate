<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>لوحة تحكم المسوقين | BARAH Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-dark: #0f172a; --secondary-dark: #1e293b; --gold: #d4af37; --text-grey: #94a3b8; --white: #ffffff; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Almarai', sans-serif; }
        body { background-color: var(--primary-dark); color: var(--white); min-height: 100vh; display: flex; flex-direction: column; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--secondary-dark); padding: 40px; border-radius: 15px; border: 1px solid var(--gold); text-align: center; width: 90%; max-width: 350px; }
        .dashboard-container { display: flex; flex: 1; }
        .sidebar { width: 260px; background: var(--secondary-dark); padding: 20px; border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
        .main-content { flex: 1; padding: 30px; background: radial-gradient(circle at top, #1e293b, #0f172a); overflow-x: hidden; }
        .logo-area { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .logo-img { height: 70px; margin-bottom: 10px; }
        .nav-links { list-style: none; }
        .nav-links li { margin-bottom: 10px; }
        .nav-links a { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--text-grey); text-decoration: none; border-radius: 8px; transition: 0.3s; font-weight: bold; }
        .nav-links a.active, .nav-links a:hover { background: rgba(212, 175, 55, 0.15); color: var(--gold); }
        .admin-form { background: var(--secondary-dark); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 40px; max-width: 800px; margin: 0 auto 40px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--gold); margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; outline: none; }
        .form-group input:focus { border-color: var(--gold); }
        .upload-box { border: 2px dashed #334155; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); }
        .btn-submit { width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .btn-submit:hover { background: #fff; }
        .ad-item { background: var(--secondary-dark); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .ad-info { display: flex; align-items: center; gap: 15px; }
        .ad-img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; border: 1px solid var(--gold); }
        .btn-delete { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; padding: 15px; }
            .form-row { grid-template-columns: 1fr; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-box">
            <i class="fas fa-user-shield" style="font-size: 3rem; color: #d4af37; margin-bottom: 15px;"></i>
            <h3 style="color: white; margin-bottom: 15px;">بوابة الموظفين</h3>
            <input type="password" id="passInput" placeholder="أدخل الكود السري" style="width: 100%; padding: 12px; margin-bottom: 15px; background: #0f172a; border: 1px solid #555; color: white; text-align: center; font-size: 1.2rem; border-radius: 5px;">
            <button onclick="checkPass()" style="background: #d4af37; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">دخول</button>
            <p id="errorMsg" style="color: #ef4444; display: none; margin-top: 10px;">الكود خطأ!</p>
        </div>
    </div>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-area"><img src="logo.png" alt="Logo" class="logo-img"><h3 style="color: var(--gold);">BARAH Admin</h3></div>
            <ul class="nav-links"><li><a href="#" class="active"><i class="fas fa-plus-circle"></i> إضافة عقار</a></li><li><a href="#adsList"><i class="fas fa-list"></i> العقارات المنشورة</a></li><li><a href="index.html" target="_blank"><i class="fas fa-external-link-alt"></i> معاينة الموقع</a></li></ul>
        </aside>
        <main class="main-content">
            <div class="admin-form">
                <h2 style="color: var(--gold); margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">إضافة وحدة جديدة</h2>
                <form id="propertyForm">
                    <div class="form-row"><div class="form-group"><label>نوع العملية</label><select id="propType"><option value="sale">بيع</option><option value="rent">إيجار</option></select></div><div class="form-group"><label>السعر (ج.م)</label><input type="number" id="propPrice" required placeholder="مثال: 1500000"></div></div>
                    <div class="form-group"><label>عنوان الإعلان</label><input type="text" id="propTitle" required placeholder="مثال: شقة 200م في الحي التاسع"></div>
                    <div class="form-row"><div class="form-group"><label>المنطقة</label><select id="propDistrict"><option value="الحي الأول">الحي الأول</option><option value="الحي الثاني">الحي الثاني</option><option value="الحي الثالث">الحي الثالث</option><option value="الحي التاسع">الحي التاسع</option><option value="العبور الجديدة">العبور الجديدة</option></select></div><div class="form-group"><label>المساحة (متر)</label><input type="number" id="propArea" placeholder="150"></div></div>
                    <div class="form-row"><div class="form-group"><label>الغرف</label><input type="number" id="propRooms" placeholder="3"></div><div class="form-group"><label>الحمامات</label><input type="number" id="propBaths" placeholder="2"></div></div>
                    <div class="form-group"><label>صور العقار (اختر 1 إلى 3 صور)</label><div class="upload-box" onclick="document.getElementById('fileInput').click()"><i class="fas fa-images" style="font-size: 2rem; color: var(--text-grey);"></i><p style="color: var(--text-grey); margin-top: 10px;">اضغط هنا لاختيار الصور</p><input type="file" id="fileInput" multiple accept="image/*" style="display: none;"></div><p id="filesCount" style="color: var(--gold); font-size: 0.9rem; margin-top: 5px;"></p></div>
                    <div class="form-group"><label>رابط فيديو يوتيوب (اختياري)</label><input type="url" id="youtubeLink" placeholder="https://youtube.com/..."></div>
                    <div class="form-group"><label>رقم الواتساب</label><input type="number" id="marketerPhone" required placeholder="010xxxxxxx"></div>
                    <button type="submit" class="btn-submit" id="submitBtn">نشر الإعلان</button><p id="statusMsg" style="text-align: center; color: var(--gold); margin-top: 10px;"></p>
                </form>
            </div>
            <div id="adsList"><h3 style="color: white; margin-bottom: 20px;">الإعلانات الحالية</h3><div id="adsContainer"></div></div>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        const firebaseConfig = { apiKey: "AIzaSyDBRcr-Np9SwYRR-cBqJDZ7FZmwk6VWLJU", authDomain: "barah-realestate-c7095.firebaseapp.com", projectId: "barah-realestate-c7095", storageBucket: "barah-realestate-c7095.firebasestorage.app", messagingSenderId: "491079034147", appId: "1:491079034147:web:bdfd6fa4d09b409aa8d896" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const storage = getStorage(app);
        window.checkPass = function() { if(document.getElementById('passInput').value === "Aa10203040") { document.getElementById('loginOverlay').style.display = 'none'; loadAds(); } else { document.getElementById('errorMsg').style.display = 'block'; } };
        document.getElementById('fileInput').addEventListener('change', function(e) { document.getElementById('filesCount').innerText = `تم اختيار ${e.target.files.length} صور`; });
        async function compressImage(file) { const imageBitmap = await createImageBitmap(file); const canvas = document.createElement('canvas'); const maxWidth = 1000; const scaleSize = maxWidth / imageBitmap.width; const newWidth = imageBitmap.width * (scaleSize < 1 ? scaleSize : 1); const newHeight = imageBitmap.height * (scaleSize < 1 ? scaleSize : 1); canvas.width = newWidth; canvas.height = newHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(imageBitmap, 0, 0, newWidth, newHeight); return new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.7)); }
        document.getElementById('propertyForm').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submitBtn'); const msg = document.getElementById('statusMsg'); const files = document.getElementById('fileInput').files;
            btn.disabled = true; btn.innerText = "جاري الرفع والنشر...";
            try { let imageUrls = []; if (files.length > 0) { try { for (let file of files) { const compressedFile = await compressImage(file); const storageRef = ref(storage, 'images/' + Date.now() + '_' + file.name); await uploadBytes(storageRef, compressedFile); const url = await getDownloadURL(storageRef); imageUrls.push(url); } } catch (storageErr) { console.error("Storage Error:", storageErr); alert("تنبيه: فشل رفع الصور. سيتم النشر بدون صور."); imageUrls.push('logo.png'); } } else { imageUrls.push('logo.png'); }
            const data = { title: document.getElementById('propTitle').value, price: Number(document.getElementById('propPrice').value), type: document.getElementById('propType').value, district: document.getElementById('propDistrict').value, specs: `${document.getElementById('propArea').value}م - ${document.getElementById('propRooms').value} غرف`, phone: document.getElementById('marketerPhone').value, youtubeLink: document.getElementById('youtubeLink').value, images: imageUrls, createdAt: Date.now() };
            await addDoc(collection(db, "properties"), data); msg.innerText = "تم النشر بنجاح! ✅"; setTimeout(() => location.reload(), 1500); } catch (err) { console.error(err); msg.innerText = "حدث خطأ: " + err.message; btn.disabled = false; btn.innerText = "نشر الإعلان"; }
        });
        async function loadAds() { const container = document.getElementById('adsContainer'); container.innerHTML = "جاري التحميل..."; const q = query(collection(db, "properties"), orderBy("createdAt", "desc")); const snapshot = await getDocs(q); container.innerHTML = ""; snapshot.forEach(docSnap => { const ad = docSnap.data(); container.innerHTML += `<div class="ad-item"><div class="ad-info"><img src="${ad.images[0] || 'logo.png'}" class="ad-img"><div><h4 style="color:white; margin-bottom:5px;">${ad.title}</h4><span style="color:#aaa;">${ad.price.toLocaleString()} ج.م</span></div></div><button class="btn-delete" onclick="deleteAd('${docSnap.id}')">حذف</button></div>`; }); }
        window.deleteAd = async function(id) { if(confirm("حذف الإعلان؟")) { await deleteDoc(doc(db, "properties", id)); loadAds(); } };
    </script>
</body>
</html>